<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo list</title>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="script/javascript" src="bootstrap.js">
</head>

<style>
    .task-list-container {
        min-width: 20rem;
        max-width: 30rem;
    }


    li  span * {
        display: inline;
    }    

</style>

<body>

    <h3>Todo list app!</h3>

    <div class="task-input-container" style="width: 20rem">
        <div class="task-warning"></div>
        <input type="text" class="input-task-name" required placeholder="Insert task name here...">
        <input type="datetime-local" min="2020-09-14T11:49" class="input-task-date" required>
        <div class="btn-group mt-2 mb-2">
            <button class="btn btn-success btn-add-task" type="submit">Add Task</button>
            <button class="btn btn-primary btn-refresh-tasks" onclick="refreshTasks()">Refresh Tasks</button>
        </div>
    </div>

    <div class="task-list-container card text-center">
        <ul class="list-group task-list">
            <!-- List items will appear here -->
        </ul>
    </div>

</body>

<script>
    const btn_addTask = document.querySelector(".btn-add-task");
    var nextTaskId = 0;

    function dataParser(rawDateObj) {
        // Date format: 2020-09-12 00:00:00 [TIMEZONE OFFSET]
        // Convert to hours difference

        const today = new Date();

        // <!-- ? HTML 'date' input type returns a date string always with 0 Timezone Offset, -->
        // <!-- ? and JavaScript gets current Date at local timezone. So, it'll be necessary a shift in hour value. -->
        // <!-- ? e.g for GMT-3: if September 14th is selected in HTML form, JS will read it as September 13th 21:00 -->
        // <!-- ? even though user is not at GMT+0. So, adding 3 to HTML date (September 14th 3:00 AM) should fix this. -->
        // <!-- ? inputs with datetime-local type returns a string already offseted. -->
        // <!-- ? However, if 'datetime-local' input type is used, then the shift won't be necessary. -->

        rawDateObj.setHours(rawDateObj.getHours() + 0); // To set to GMT-3 timezone with date input type: add 3.
        
        // Math.abs works with date subtraction by returning difference in milliseconds.
        // 1 hour is equal to 3.6 million milliseconds
        // Then, it is necessary to convert the float value to an integer

        var remainingH = parseInt(Math.abs(rawDateObj - new Date())/3600000)

        let result;

        // Due to the fact it's a float, add 1 minute to correction.
        var remainingMins = parseInt(Math.abs(rawDateObj - new Date())/60000) + 1;

        if (remainingH >= 24) {
            // Works like this:
            // 27 hours remaning -> remaining days = 24.125 -> parseInt(remainingD/24) -> 1
            // remaning hours = 27 % 24 -> 3

            remainingDays = parseInt(remainingH/24);
            remainingH %= 24;

            if(remainingDays > 1) {
                remainingH == 1
                ?
                    result = remainingDays + " dias e " + remainingH + " hora restando"
                :
                    result = remainingDays + " dias e " + remainingH + " horas restando";
            } else if(remainingDays == 1) {
                remainingH == 1
                ?
                    result = remainingDays + " dia e " + remainingH + " hora restando"
                :
                    result = remainingDays + " dia e " + remainingH + " horas restando";
            }

         
        } else {
            
            // There's a problem with hour evaluation. If there are 1 hour and 60 minutes remaining,
            // it will see as 1 hour remaining, but this is not correct.

            // If there's 2 hours remaining, then there will be 120 minutes remaining.
            // In order to not get a 3 hour difference between, for example, 13:00 and 15:00,
            // subtract (60*remainingH) minutes if minutes are greater than 59.

            // so, if minutes are still greater than 59, get the modulus of them divided by 60 and
            // add 1 to remaining hours.

            if (remainingMins > 59) remainingMins -= 60*remainingH;

            if (remainingMins > 59) {
                remainingH = remainingH + 1;
                remainingMins = remainingMins % 60;
            }

            if(remainingH == 1 && remainingMins != 0) {
                result = remainingH + " hora e " + remainingMins + " minutos restando";
            } else if(remainingH == 1 && remainingMins == 0) {
                result = "1 hora restando";
            } else if(remainingH == 0 && remainingMins != 0) {
                result = remainingMins + " minutos restando";
            } else {
                result = remainingH + " horas restando";
            }
    
        }
       
        return result;
    }

    function addTask(name, remainingTime, conclusionDate) {
        const taskList = document.querySelector(".task-list");

        var newTaskElement = 
        `
        <li class="list-group-item d-flex flex-nowrap align-items-center" taskID=${nextTaskId} taskDate=${conclusionDate}>

            <span class="flex-grow-1 task-content">
                <p class="task-name">${name}</p>
                <strong>|</strong>
                <p class="task-date">${remainingTime}</p> 
            </span>

            <button class="btn btn-warning mr-2">Edit</button>
            <button class="btn btn-danger" onclick="deleteTask(${nextTaskId})">Delete</button>
        </li>
        `
        taskList.innerHTML += newTaskElement;
        nextTaskId++;
    }

    function deleteTask(id) {
        // Delete li where taskID="id"
        document.querySelector("li[taskID='"+id+"']").remove();


    }

    function dismissWarning() {
        document.querySelector(".task-warning").innerHTML = ""
    }

    btn_addTask.addEventListener('click', () => {
        // Gets raw inputs
        const taskName = document.querySelector(".input-task-name").value;
        const taskDate = document.querySelector(".input-task-date").value;

        // If any of the entries is empty, then warning pops up and inputs are cleared. Else, go parse date and add task.
        if (taskName == '' || taskDate == '') {
            document.querySelector(".task-warning").innerHTML = `<button class="btn btn-primary btn-sm mb-2" onclick="dismissWarning()">Um ou mais campos est√£o em branco!</button>`;
            taskName.innerHTML = "";
            taskDate.innerHTML = "";
        } else {
        // Converts data string into a valid Date object for parsing.
        taskDateParsed = dataParser(new Date(taskDate));

        addTask(taskName, taskDateParsed, taskDate);
        }
    })

    function refreshTasks() {
        tasks = document.querySelectorAll(".task-list li");

        // For each task...
        for(var element of tasks) {
            var taskDate = element.getAttribute("taskDate");

            // Gets string with time remaining based on taskDate
            var refreshedTimeRemaining = dataParser(new Date(taskDate));
            // Selects <p> textContent from task
            document.querySelector(`li[taskDate="${taskDate}"] .task-date`).textContent = refreshedTimeRemaining;
            
        }
    }
</script>
</html>